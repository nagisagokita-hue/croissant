<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ Croissant Map for Hunters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // ã‚ãªãŸãŒå–å¾—ã—ãŸFirebaseã®è¨­å®šã‚’é©ç”¨
        const firebaseConfig = {
            apiKey: "AIzaSyAPymoq3-IAvDo0txdQAe4GyTWMqFATsx4",
            authDomain: "croissant-hunters.firebaseapp.com",
            projectId: "croissant-hunters",
            storageBucket: "croissant-hunters.firebasestorage.app",
            messagingSenderId: "847830842925",
            appId: "1:847830842925:web:0c6902a1deecf684d682a4",
            measurementId: "G-4KLWD1Y6MG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«windowã«ç™»éŒ²
        window.fb = { db, storage, collection, addDoc, onSnapshot, query, orderBy, ref, uploadString, getDownloadURL };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; margin: 0; }
        .croissant-card img { transition: transform 0.3s ease; }
        .croissant-card:hover img { transform: scale(1.05); }
    </style>
</head>
<body class="bg-orange-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const WORLD_PATHS = [
            { name: 'North America', d: "M 150 100 L 180 80 L 250 85 L 320 120 L 330 200 L 280 230 L 200 210 L 140 150 Z" },
            { name: 'South America', d: "M 280 260 L 330 280 L 340 330 L 300 420 L 260 380 L 250 300 Z" },
            { name: 'Europe', d: "M 480 120 L 530 110 L 550 140 L 530 180 L 480 170 L 470 140 Z" },
            { name: 'Africa', d: "M 470 190 L 530 180 L 560 230 L 540 330 L 480 340 L 450 250 Z" },
            { name: 'Asia', d: "M 550 120 L 700 80 L 850 130 L 880 250 L 750 300 L 600 280 L 540 200 Z" },
            { name: 'Australia', d: "M 780 330 L 850 320 L 870 380 L 800 410 L 760 370 Z" },
            { name: 'Japan', d: "M 835 155 L 845 155 L 850 170 L 840 180 Z" }
        ];

        const CroissantMap = () => {
            const [croissants, setCroissants] = useState([]);
            const [viewMode, setViewMode] = useState('grid');
            const [showForm, setShowForm] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [formData, setFormData] = useState({ shopName: '', location: '', rating: 5, comment: '', lat: 35.6762, lng: 139.6503, photo: null });

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.fb) {
                        clearInterval(checkFB);
                        const q = window.fb.query(window.fb.collection(window.fb.db, "posts"), window.fb.orderBy("createdAt", "desc"));
                        window.fb.onSnapshot(q, (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setCroissants(data);
                        });
                    }
                }, 100);
            }, []);

            const getCoords = (lat, lng) => ({ x: ((lng + 180) / 360) * 1000, y: ((90 - lat) / 180) * 500 });

            const handlePhotoChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        setFormData({ ...formData, photo: canvas.toDataURL('image/jpeg', 0.7) });
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleSubmit = async () => {
                if (!formData.shopName || isUploading) return alert('åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                setIsUploading(true);
                try {
                    let photoUrl = null;
                    if (formData.photo) {
                        const storageRef = window.fb.ref(window.fb.storage, `images/${Date.now()}.jpg`);
                        await window.fb.uploadString(storageRef, formData.photo, 'data_url');
                        photoUrl = await window.fb.getDownloadURL(storageRef);
                    }
                    await window.fb.addDoc(window.fb.collection(window.fb.db, "posts"), {
                        ...formData,
                        photo: photoUrl,
                        createdAt: Date.now()
                    });
                    setShowForm(false);
                    setFormData({ shopName: '', location: '', rating: 5, comment: '', lat: 35.6762, lng: 139.6503, photo: null });
                } catch (e) {
                    console.error(e);
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebaseã®ãƒ«ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                setIsUploading(false);
            };

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [viewMode, showForm, croissants, formData.photo]);

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-amber-700 text-white p-6 shadow-xl flex justify-between items-center border-b-4 border-amber-900">
                        <h1 className="text-2xl font-black italic tracking-tighter uppercase">ğŸ¥ Croissant Map for Hunters</h1>
                        <button onClick={() => setShowForm(true)} className="bg-amber-400 text-amber-900 px-6 py-2 rounded-full font-black shadow-md hover:bg-amber-300 transition">ãƒãƒ³ãƒˆã‚’é–‹å§‹ï¼</button>
                    </header>

                    <div className="max-w-6xl mx-auto p-6">
                        <div className="flex gap-2 mb-8 bg-amber-100 w-fit p-1 rounded-2xl shadow-inner border border-amber-200">
                            <button onClick={() => setViewMode('grid')} className={`px-6 py-2 rounded-xl font-bold transition ${viewMode === 'grid' ? 'bg-white text-amber-700 shadow-sm' : 'text-amber-800/50'}`}>ãƒãƒ³ãƒˆä¸€è¦§</button>
                            <button onClick={() => setViewMode('map')} className={`px-6 py-2 rounded-xl font-bold transition ${viewMode === 'map' ? 'bg-white text-amber-700 shadow-sm' : 'text-amber-800/50'}`}>ä¸–ç•Œåœ°å›³</button>
                        </div>

                        {viewMode === 'grid' ? (
                            <div className="grid md:grid-cols-3 gap-6">
                                {croissants.length === 0 && <p className="col-span-3 text-center py-20 text-amber-800 italic">ã¾ã ãƒãƒ³ãƒˆè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒãƒ³ã‚¿ãƒ¼ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p>}
                                {croissants.map(c => (
                                    <div key={c.id} className="croissant-card bg-white rounded-[2rem] shadow-sm border border-amber-100 overflow-hidden hover:shadow-2xl transition-all">
                                        {c.photo ? <img src={c.photo} className="w-full h-56 object-cover" /> : <div className="w-full h-56 bg-amber-50 flex items-center justify-center text-amber-200"><i data-lucide="image" className="w-12 h-12"></i></div>}
                                        <div className="p-8">
                                            <h3 className="text-xl font-black text-amber-900 mb-1">{c.shopName}</h3>
                                            <div className="text-amber-600 text-xs font-bold flex items-center gap-1 mb-4 uppercase tracking-widest"><i data-lucide="map-pin" className="w-3 h-3"></i> {c.location}</div>
                                            <div className="flex gap-1 mb-4">
                                                {[...Array(5)].map((_, i) => <i key={i} data-lucide="star" className={`w-4 h-4 ${i < c.rating ? 'fill-amber-400 text-amber-400' : 'text-gray-200'}`}></i>)}
                                            </div>
                                            <p className="text-slate-600 leading-relaxed italic border-l-4 border-amber-100 pl-4">"{c.comment}"</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-sky-100 rounded-[2.5rem] p-6 border-8 border-white shadow-2xl aspect-[2/1] relative overflow-hidden">
                                <svg viewBox="0 0 1000 500" className="w-full h-full">
                                    {WORLD_PATHS.map((p, i) => <path key={i} d={p.d} fill="#e2f5d3" stroke="#94d6a1" strokeWidth="1.5" />)}
                                    {croissants.map(c => {
                                        const {x, y} = getCoords(c.lat, c.lng);
                                        return <circle key={c.id} cx={x} cy={y} r="6" fill="#d97706" stroke="white" strokeWidth="2" />;
                                    })}
                                </svg>
                            </div>
                        )}
                    </div>

                    {showForm && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-50 flex items-center justify-center p-4 overflow-y-auto">
                            <div className="bg-white rounded-[2.5rem] max-w-3xl w-full flex flex-col md:flex-row overflow-hidden shadow-2xl border border-white/20 my-auto">
                                <div className="md:w-1/2 bg-sky-50 p-8 border-r border-slate-100 flex flex-col gap-6">
                                    <h3 className="text-xs font-black text-sky-800 mb-2 flex items-center gap-2 italic tracking-wider uppercase"><i data-lucide="navigation" className="w-3 h-3"></i> 1. å ´æ‰€ã‚’é¸æŠ</h3>
                                    <svg viewBox="0 0 1000 500" className="w-full bg-sky-100 rounded-xl cursor-crosshair border-2 border-sky-200 shadow-inner" onClick={(e) => {
                                        const rect = e.currentTarget.getBoundingClientRect();
                                        const x = ((e.clientX - rect.left) / rect.width) * 1000, y = ((e.clientY - rect.top) / rect.height) * 500;
                                        setFormData({ ...formData, lng: (x / 1000) * 360 - 180, lat: 90 - (y / 500) * 180 });
                                    }}>
                                        {WORLD_PATHS.map((p, i) => <path key={i} d={p.d} fill="white" stroke="#cbd5e1" />)}
                                        <circle cx={getCoords(formData.lat, formData.lng).x} cy={getCoords(formData.lat, formData.lng).y} r="12" fill="#f59e0b" stroke="white" strokeWidth="3" />
                                    </svg>
                                    <label className="cursor-pointer block">
                                        <div className="w-full h-40 bg-white border-2 border-dashed border-amber-200 rounded-3xl flex items-center justify-center overflow-hidden transition hover:bg-amber-50">
                                            {formData.photo ? <img src={formData.photo} className="w-full h-full object-cover" /> : <div className="text-center font-bold text-amber-400 text-xs">å†™çœŸã‚’æ’®ã‚‹ãƒ»é¸ã¶</div>}
                                        </div>
                                        <input type="file" accept="image/*" className="hidden" onChange={handlePhotoChange} />
                                    </label>
                                </div>
                                <div className="md:w-1/2 p-10 space-y-6">
                                    <h2 className="text-2xl font-black text-amber-900 italic uppercase">ãƒãƒ³ãƒˆå ±å‘Š</h2>
                                    <input placeholder="åº—å" className="w-full border-b-2 border-amber-100 p-2 outline-none font-bold text-xl" onChange={e => setFormData({...formData, shopName: e.target.value})} />
                                    <input placeholder="ã‚¨ãƒªã‚¢" className="w-full border-b border-slate-200 p-2 text-sm outline-none" onChange={e => setFormData({...formData, location: e.target.value})} />
                                    <div className="flex gap-2">
                                        {[1,2,3,4,5].map(s => <button key={s} onClick={()=>setFormData({...formData, rating: s})}><i data-lucide="star" className={`w-6 h-6 ${s <= formData.rating ? 'fill-amber-400 text-amber-400' : 'text-slate-200'}`}></i></button>)}
                                    </div>
                                    <textarea placeholder="ãƒãƒ³ãƒˆã®æ„Ÿæƒ³ã‚’ã©ã†ãï¼" className="w-full bg-slate-50 rounded-2xl p-4 h-24 outline-none resize-none text-sm" onChange={e => setFormData({...formData, comment: e.target.value})}></textarea>
                                    <button onClick={handleSubmit} disabled={isUploading} className="w-full bg-amber-700 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-amber-800 transition">
                                        {isUploading ? 'é€ä¿¡ä¸­...' : 'ä¸–ç•Œã¸è¨˜éŒ²ã‚’åˆ»ã‚€ ğŸ¥'}
                                    </button>
                                    <button onClick={()=>setShowForm(false)} className="w-full text-slate-400 text-xs font-bold uppercase tracking-widest">é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CroissantMap />);
    </script>
</body>
</html>
